stages:
  - release_build

release_build_master:
  stage: release_build
  retry: 2
  image:
    name: nikolaik/python-nodejs:python3.8-nodejs10-alpine
  variables:
    NODE_ENV: "development"
  script:
    - apk add --no-cache git gcc libffi-dev python3-dev musl-dev openssl-dev
    - git config --global user.email $(git --no-pager show -s --format='%ae' HEAD)
    - git config --global user.name $(git --no-pager show -s --format='%an' HEAD)
    - yarn install --pure-lockfile --cache-folder .yarn-cache
    - pip install bumpversion
    - pip install -r requirements-dev.txt
    - bumpversion --allow-dirty release package.json sickrage/version.txt
    - git checkout -b release-$(cat sickrage/version.txt)
    - npx auto-changelog -v $(cat sickrage/version.txt) --hide-credit --package --commit-limit false --ignore-commit-pattern \[TASK\].*
    - yarn run build
    - python checksum-generator.py
    - git add --all
    - git commit -m "[TASK] Releasing v$(cat sickrage/version.txt)"
    - git fetch . release-$(cat sickrage/version.txt):master
    - git fetch . release-$(cat sickrage/version.txt):develop
    - git tag -a $(cat sickrage/version.txt) -m "Release v$(cat sickrage/version.txt) master"
    - git push https://$GIT_ACCESS_USER:$GIT_ACCESS_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git HEAD:master --follow-tags
    - git checkout develop
    - bumpversion --allow-dirty patch package.json sickrage/version.txt
    - python checksum-generator.py
    - git add --all
    - git commit -m "[TASK] Bump develop branch to v$(cat sickrage/version.txt)"
    - git push https://$GIT_ACCESS_USER:$GIT_ACCESS_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git HEAD:develop --follow-tags
  when: manual
  only:
    - /^[0-9.]+dev[0-9]+$/@echel0n/sickrage
  except:
    refs:
      - branches
      - triggers
    variables:
      - $CI_COMMIT_MESSAGE =~ /\[TASK\] Releasing/

release_build_develop:
  stage: release_build
  retry: 2
  image:
    name: nikolaik/python-nodejs:python3.8-nodejs10-alpine
  variables:
    NODE_ENV: "development"
  script:
    - apk add --no-cache git gcc libffi-dev python3-dev musl-dev openssl-dev
    - yarn install --pure-lockfile --cache-folder .yarn-cache
    - pip install bumpversion
    - pip install -r requirements-dev.txt
    - bumpversion --allow-dirty dev package.json sickrage/version.txt
    - npx auto-changelog -v $(cat sickrage/version.txt) --hide-credit --unreleased --package --commit-limit false --ignore-commit-pattern \[TASK\].*
    - yarn run build
    - python checksum-generator.py
    #    - python setup.py extract_messages
    #    - crowdin-cli-py upload sources
    #    - crowdin-cli-py download
    #    - python setup.py compile_catalog
    - git config --global user.email $(git --no-pager show -s --format='%ae' HEAD)
    - git config --global user.name $(git --no-pager show -s --format='%an' HEAD)
    - git add --all
    - git commit -m "[TASK] Pre-Releasing v$(cat sickrage/version.txt)"
    - git tag -a $(cat sickrage/version.txt) -m "Pre-release v$(cat sickrage/version.txt)"
    - git push https://$GIT_ACCESS_USER:$GIT_ACCESS_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git HEAD:$CI_COMMIT_REF_NAME --follow-tags
  only:
    - develop@echel0n/sickrage
  except:
    refs:
      - tags
      - triggers
    variables:
      - $CI_COMMIT_MESSAGE =~ /\[TASK\] Pre-Releasing/
      - $CI_COMMIT_MESSAGE =~ /\[TASK\] Bump/